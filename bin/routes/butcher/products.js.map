{"version":3,"sources":["../src/routes/butcher/products.ts"],"names":[],"mappings":"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","file":"products.js","sourcesContent":["import * as express from \"express\";\nimport { ViewRouter } from '../../lib/router';\nimport moment = require('moment');\nimport { CacheManager } from \"../../lib/cache\";\nimport Butcher from \"../../db/models/butcher\";\nimport { Auth } from \"../../lib/common\";\nimport ButcherProduct from \"../../db/models/butcherproduct\";\nimport Product from \"../../db/models/product\";\nimport Area from \"../../db/models/area\";\nimport { ButcherRouter } from \"./home\";\nimport * as _ from \"lodash\";\nimport Helper from \"../../lib/helper\";\nimport db from \"../../db/context\";\nimport { Transaction } from \"sequelize\";\nimport ButcherPriceHistory from \"../../db/models/butcherpricehistory\";\n\n\nexport default class Route extends ButcherRouter {\n\n    sellingProducts = [];\n    otherProducts = [];\n    goto: string;\n    _ = _;\n\n    async getProducts() {\n        return await Product.findAll({\n            include: [{\n                all: true\n            }\n            ],\n            order: [\"Tag1\", \"Name\"],\n            where: {\n\n            }\n        });\n    }\n\n\n    getProductUnits(product: Product, bp) {\n        let result = [];\n        (product.unit1 && product.unit1 != \"\" ) ? result.push({\n            unit: product.unit1,\n            unitTitle: product.unit1title,\n            unitWeight: product.unit1weight,\n            kgRatio: product.unit1kgRatio,\n            desc: product.unit1desc,\n            enabled: bp.unit1enabled,\n            butcherNote: product.unit1ButcherNote,\n            butcherUnitWeight: bp.unit1weight,\n            butcherkgRatio: bp.unit1kgRatio,\n\n            price: Helper.asCurrency(bp.unit1price > 0 ? bp.unit1price: product.unit1kgRatio * bp.kgPrice)\n    \n        }) : null;\n        (product.unit2 && product.unit2 != \"\") ? result.push(\n            {\n                unit: product.unit2,\n                unitTitle: product.unit2title,\n                unitWeight: product.unit2weight,\n                kgRatio: product.unit2kgRatio,\n\n                butcherUnitWeight: bp.unit2weight,\n                butcherkgRatio: bp.unit2kgRatio,\n\n                desc: product.unit2desc,\n                enabled: bp.unit2enabled,\n                butcherNote: product.unit2ButcherNote,\n\n                price: Helper.asCurrency(bp.unit2price > 0 ? bp.unit2price: product.unit2kgRatio * bp.kgPrice)\n\n            }\n        ) : null;\n        (product.unit3 && product.unit3 != \"\") ? result.push(\n            {\n                unit: product.unit3,\n                unitTitle: product.unit3title,\n                                unitWeight: product.unit3weight,\n                                butcherUnitWeight: bp.unit3weight,\n                                butcherkgRatio: bp.unit3kgRatio,\n\n                kgRatio: product.unit3kgRatio,\n                desc: product.unit3desc,\n                enabled: bp.unit3enabled,\n                butcherNote: product.unit3ButcherNote,\n                price: Helper.asCurrency(bp.unit3price > 0 ? bp.unit3price: product.unit3kgRatio * bp.kgPrice)\n\n            }\n        ) : null;\n        return result;\n    }\n\n\n\n    getButcherProductInfo(butcherProduct, product = null) {\n        //let butcherProduct = this.butcher.products.find(c => c.productid == productid)\n        return butcherProduct ? {\n            displayOrder: butcherProduct.displayOrder,\n            enabled: butcherProduct.enabled,\n            bp: butcherProduct,\n            product: product || butcherProduct.product,\n            unit1price: butcherProduct.unit1price,            \n            unit2price: butcherProduct.unit2price,\n            unit3price: butcherProduct.unit3price,\n            unit1enabled: butcherProduct.unit1enabled,\n            unit2enabled: butcherProduct.unit2enabled,\n            unit3enabled: butcherProduct.unit3enabled,\n            unit1kgRatio: butcherProduct.unit1kgRatio,\n            unit2kgRatio: butcherProduct.unit2kgRatio,\n            unit3kgRatio: butcherProduct.unit3kgRatio,\n\n            unit1weight: butcherProduct.unit1weight,\n            unit2weight: butcherProduct.unit2weight,\n            unit3weight: butcherProduct.unit3weight,\n\n            vitrin: butcherProduct.vitrin,\n            kgPrice: butcherProduct.kgPrice,\n            mddesc: butcherProduct.mddesc,\n            longdesc: butcherProduct.longdesc\n        } : {\n                displayOrder: \"\",\n                enabled: false,\n                unit1price: 0,\n                unit2price: 0,\n                unit3price: 0,\n                unit1enabled: true,\n                unit2enabled: true,\n                unit3enabled: true,\n                vitrin: false,\n                kgPrice: 0,\n                unit1kgRatio: 0,\n                unit2kgRatio: 0,\n                unit3kgRatio: 0,\n                unit1weight: '',\n                unit2weight: '',\n                unit3weight: '',\n                mddesc: \"\",\n                longdesc:\"\",\n                product: product\n            }\n    }\n\n    async setProducts() {\n        let selling = this.butcher.products.filter(p => {\n            return true\n        })\n        selling = _.sortBy(selling, [\"displayOrder\"]).reverse();\n\n        let allproducts = await this.getProducts()\n\n        let others = allproducts.filter(p => {\n            let bp = this.butcher.products.find(bp => {\n                return bp.productid == p.id\n            })\n            return !bp\n        })\n        others = _.sortBy(others, [\"displayOrder\"]).reverse();\n\n        this.sellingProducts = selling.map(p => this.getButcherProductInfo(p));\n        this.otherProducts = others.map(p => this.getButcherProductInfo(null, p));\n    }\n\n    async manageHistory(rec: ButcherProduct, t: Transaction) {\n        if (!rec.enabled)\n            return;            \n        let existing = await ButcherPriceHistory.findOne({\n            where: {\n                butcherid: rec.butcherid,\n                productid: rec.productid,                \n            },\n            order: [['id', 'desc']],            \n        })\n        if (existing) {\n            if (existing.unit1price == rec.unit1price && \n                existing.unit2price == rec.unit2price &&\n                existing.unit3price == rec.unit3price &&\n                existing.unit4price == rec.unit4price &&\n                existing.unit5price == rec.unit5price &&\n                existing.kgPrice == rec.kgPrice)\n                return;\n        }    \n        \n        let newItem = new ButcherPriceHistory();\n        newItem.unit1price = rec.unit1price;\n        newItem.unit2price = rec.unit2price;\n        newItem.unit3price = rec.unit3price;\n        newItem.unit4price = rec.unit4price;\n        newItem.unit5price = rec.unit5price;\n        newItem.kgPrice = rec.kgPrice;\n        newItem.productid = rec.productid;\n        newItem.butcherid = rec.butcherid;\n        return newItem.save({\n            transaction: t\n        })\n    }\n\n    async saveProductRoute() {\n        await this.setButcher();\n\n        let productid = parseInt(this.req.body.productid);\n        let newItem: ButcherProduct = await ButcherProduct.findOne({\n            where: {\n                butcherid: this.butcher.id,\n                productid: productid\n            }\n        });\n\n        if (newItem == null)\n            newItem = new ButcherProduct();\n\n        newItem.enabled = this.req.body.productenabled == \"on\";\n        newItem.vitrin = this.req.body.productvitrin == \"on\";\n        newItem.butcherid = this.butcher.id;\n        newItem.productid = productid;\n        newItem.displayOrder = (this.req.body.productdisplayorder ? parseInt(this.req.body.productdisplayorder) : newItem.displayOrder)\n        newItem.unit1price = this.req.body.unit1price ? parseFloat(this.req.body.unit1price) : 0;\n        newItem.unit2price = this.req.body.unit2price ? parseFloat(this.req.body.unit2price) : 0;\n        newItem.unit3price = this.req.body.unit3price ? parseFloat(this.req.body.unit3price) : 0;\n        newItem.kgPrice = this.req.body.productkgPrice ? parseFloat(this.req.body.productkgPrice) : 0;\n        newItem.mddesc = this.req.body.productmddesc;\n        newItem.longdesc = this.req.body.productlongdesc;\n\n        newItem.unit1enabled = this.req.body.unit1enabled ==\"on\";\n        newItem.unit2enabled = this.req.body.unit2enabled ==\"on\";\n        newItem.unit3enabled = this.req.body.unit3enabled ==\"on\";\n\n        newItem.unit1kgRatio = this.req.body.unit1butcherkgRatio ? parseFloat(this.req.body.unit1butcherkgRatio) : 0;\n        newItem.unit2kgRatio = this.req.body.unit2butcherkgRatio ? parseFloat(this.req.body.unit2butcherkgRatio) : 0;\n        newItem.unit3kgRatio = this.req.body.unit3butcherkgRatio ? parseFloat(this.req.body.unit3butcherkgRatio) : 0;\n\n        newItem.unit1weight = this.req.body.unit1butcherunitWeight;\n        newItem.unit2weight = this.req.body.unit2butcherunitWeight;\n        newItem.unit3weight = this.req.body.unit3butcherunitWeight;\n\n\n        if (\n            newItem.enabled && ( \n            !(Helper.nvl(newItem.kgPrice) || Helper.nvl(newItem.unit1price) || Helper.nvl(newItem.unit2price) || Helper.nvl(newItem.unit3price)) ||\n            !(newItem.unit1enabled || newItem.unit2enabled || newItem.unit3enabled))\n        ) {\n            this.goto = \"p\" + productid.toString();\n            await this.setProducts();\n            this.res.render(\"pages/butcher.products.ejs\", this.viewData({\n                _usrmsg: {\n                    text: \"Geçerli satış değerleri girmeden ürün satılamaz\",\n                    type: 'danger'\n                }\n            }))\n        } else {\n            await db.getContext().transaction((t:Transaction)=> {\n                return newItem.save({\n                    transaction: t\n                }).then(()=> this.manageHistory(newItem, t))\n            })\n            \n            await this.setButcher();\n            await this.setProducts();\n            this.goto = \"p\" + productid.toString();\n\n            this.res.render(\"pages/butcher.products.ejs\", this.viewData({\n\n            }))\n\n        }\n\n\n    }\n\n    async viewListRoute() {\n        await this.setButcher();\n        await this.setProducts();\n        // (p.kgPrice > 0 || p.unit1price > 0 || p.unit2price > 0 || p.unit3price > 0)\n\n\n        this.res.render(\"pages/butcher.product-list.ejs\", this.viewData({\n\n        }))        \n    }\n\n    async viewRoute() {\n        await this.setButcher();\n        await this.setProducts();\n        // (p.kgPrice > 0 || p.unit1price > 0 || p.unit2price > 0 || p.unit3price > 0)\n\n\n        this.res.render(\"pages/butcher.products.ejs\", this.viewData({\n\n        }))\n    }\n\n    static SetRoutes(router: express.Router) {\n        router.get(\"/urunler\", Route.BindRequest(this.prototype.viewRoute));\n        router.get(\"/urun-listesi\", Route.BindRequest(this.prototype.viewListRoute));\n        router.get(\"/product/save\", Route.BindRequest(this.prototype.viewRoute));\n        router.post(\"/product/save\", Route.BindRequest(this.prototype.saveProductRoute));\n    }\n}\n\n"],"sourceRoot":"../../../src/"}