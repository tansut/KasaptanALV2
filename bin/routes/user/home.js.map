{"version":3,"sources":["../src/routes/user/home.ts"],"names":[],"mappings":"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","file":"home.js","sourcesContent":["import * as express from \"express\";\nimport { ViewRouter } from '../../lib/router';\nimport moment = require('moment');\nimport User from \"../../db/models/user\";\nimport UserRoute from \"../api/user\";\nimport { Order, OrderItem } from \"../../db/models/order\";\nimport { PermissionError } from \"../../lib/http\";\nimport * as _ from \"lodash\";\n\n\nimport  OrderApi from '../api/order';\nimport AccountModel from \"../../db/models/accountmodel\";\nimport { Account } from \"../../models/account\";\nimport Helper from \"../../lib/helper\";\nimport { PuanCalculator } from \"../../lib/commissionHelper\";\nimport { PuanResult } from \"../../models/puan\";\n\nexport default class Route extends ViewRouter {\n    order: Order;\n    api: OrderApi;\n    user: User;\n    balance: AccountModel;\n    shouldBePaid = 0.00;\n    puanBalanceButcher: AccountModel;\n    puanBalanceKalitte: AccountModel;\n    earnedPuanButcher = 0.00;\n    earnedPuanKalitte = 0.00;\n    earnedPuanTotal = 0.00;\n    mayEarnPuanTotal = 0.00;\n\n    possiblePuanList: PuanResult[] = [];\n\n    puanAccountsKalitte: AccountModel[] = []\n    puanAccountsButcher: AccountModel[] = []\n\n    async getOrderSummary() {        \n        this.balance = this.order.workedAccounts.find(p=>p.code == 'total')\n        this.shouldBePaid = Helper.asCurrency(this.balance.alacak - this.balance.borc);\n        this.puanBalanceKalitte = this.order.kalittePuanAccounts.find(p=>p.code == 'total');  \n        this.puanBalanceButcher = this.order.butcherPuanAccounts.find(p=>p.code == 'total');  \n        this.earnedPuanKalitte = this.puanBalanceKalitte ? Helper.asCurrency(this.puanBalanceKalitte.alacak -   this.puanBalanceKalitte.borc):0.00\n        this.earnedPuanButcher = this.puanBalanceButcher ? Helper.asCurrency(this.puanBalanceButcher.alacak -   this.puanBalanceButcher.borc):0.00\n        this.earnedPuanTotal = Helper.asCurrency(this.earnedPuanKalitte + this.earnedPuanButcher)\n        if (this.shouldBePaid > 0) {\n            this.possiblePuanList = this.api.getPossiblePuanGain(this.order, this.shouldBePaid);\n            this.possiblePuanList.forEach(pg=>this.mayEarnPuanTotal+=pg.earned)\n            this.mayEarnPuanTotal = Helper.asCurrency(this.mayEarnPuanTotal)\n        }\n    }\n\n    render(view, data?) {\n        data = data || {}\n        data['user'] = this.user;\n        this.res.render(view, this.viewData(data))\n    }\n\n    async viewProfile() {\n        this.user = await User.findByPk(this.req.user.id);\n        this.render(\"pages/user.home.ejs\");\n    }\n\n    async viewOrders() {\n        this.user = await User.findByPk(this.req.user.id);\n        let orders = await Order.findAll({\n            where: {\n                userid: this.req.user.id\n            },\n            order: [[\"updatedon\", \"DESC\"]],\n            include: [{\n                all: true\n            }]\n        })\n        this.render(\"pages/user.orders.ejs\", {\n            orders: orders\n        });\n    }\n\n    async emailOrderDetails() {\n        let api = new OrderApi(this.constructorParams);\n        let order = await api.getOrder(this.req.params.orderid)\n        this.render(\"email/order.started.ejs\", api.getView(order));                            \n    }\n\n\n\n    \n    async getUserSummary() {        \n        \n        this.puanAccountsKalitte = await AccountModel.list([Account.generateCode(\"musteri-kalitte-kazanilan-puan\", [this.user.id, 1]),\n        Account.generateCode(\"musteri-kalitte-kazanilan-puan\", [this.user.id, 2])])\n        this.puanAccountsButcher = await AccountModel.list([Account.generateCode(\"musteri-kasap-kazanilan-puan\", [this.user.id])])\n    }\n\n    async viewOrderDetails() {\n        let api = this.api = new OrderApi(this.constructorParams);\n        this.user = await User.findByPk(this.req.user.id);\n        let order = this.order = await api.getOrder(this.req.params.orderid, true);\n        await this.getOrderSummary();\n        this.render(\"pages/user.order.details.ejs\", {...api.getView(order), ...{enableImgContextMenu: true} }   );\n    }\n\n    async saveProfile() {\n        this.user = await User.findByPk(this.req.user.id);\n        this.user.name = this.req.body.name;\n        await this.user.save();\n        this.render(\"pages/user.home.ejs\")\n    }\n\n    async viewPassword() {\n        this.user = await User.findByPk(this.req.user.id);\n        this.render(\"pages/user.password.ejs\");\n    }\n\n    async savePassword() {\n        this.user = await User.findByPk(this.req.user.id);\n        if (this.user.verifyPassword(this.req.body.oldpass)) {\n            this.user.setPassword(this.req.body.newpass);\n            await this.user.save();\n            this.render(\"pages/user.password.ejs\", {\n                _usrmsg: {\n                    type: 'success',\n                    text: 'Şifreniz değiştirildi.'\n                }\n            })\n        } else {\n            this.render(\"pages/user.password.ejs\", {\n                _usrmsg: {\n                    type: 'danger',\n                    text: 'Geçersiz şifre'\n                }\n            })\n        }\n\n    }\n\n    async viewPuans() {\n        this.user = await User.findByPk(this.req.user.id);\n        await this.getUserSummary();\n        this.render(\"pages/user.puans.ejs\");\n    }\n\n\n    async signoff() {\n        let userRoute = new UserRoute(this.constructorParams);\n        userRoute.signOff();\n        this.res.redirect(\"/\");\n    }\n\n    static SetRoutes(router: express.Router) {\n        router.get(\"/\", Route.BindRequest(Route.prototype.viewProfile));\n        router.get(\"/profile\", Route.BindRequest(Route.prototype.viewProfile));\n        router.get(\"/password\", Route.BindRequest(Route.prototype.viewPassword));\n        router.post(\"/password\", Route.BindRequest(Route.prototype.savePassword));\n        router.post(\"/profile\", Route.BindRequest(Route.prototype.saveProfile));\n        router.get(\"/orders\", Route.BindRequest(Route.prototype.viewOrders));\n        router.get(\"/puans\", Route.BindRequest(Route.prototype.viewPuans));\n        router.get(\"/orders/:orderid\", Route.BindRequest(Route.prototype.viewOrderDetails));\n        router.get(\"/orders/:orderid/email\", Route.BindRequest(Route.prototype.emailOrderDetails));\n        router.get(\"/signoff\", Route.BindRequest(Route.prototype.signoff));\n\n    }\n}\n\n"],"sourceRoot":"../../../src/"}