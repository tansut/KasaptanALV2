{"version":3,"sources":["../src/lib/tasks/productstats.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,yCAAsC;AACtC,iDAA8C;AAC9C,gCAAgC;AAKhC,MAAqB,YAAa,SAAQ,mBAAQ;IAE9C,IAAI,QAAQ;QACR,OAAO,eAAe,CAAA;IAC1B,CAAC;IAIK,GAAG;;YACL,OAAO,CAAC,GAAG,CAAC,2BAA2B,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,CAAA;YACpD,MAAM,aAAK,CAAC,SAAS,CAAC,KAAK,CAAC;;;;;;;;;;;;;;SAc3B,EACG;gBACI,IAAI,EAAE,EAAE,CAAC,UAAU,CAAC,UAAU;aACjC,CAAC,CAAC;YACP,OAAO,CAAC,GAAG,CAAC,wBAAwB,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,CAAA;QACrD,CAAC;KAAA;CACJ;AA9BD,+BA8BC","file":"productstats.js","sourcesContent":["import { BaseTask } from \"./basetask\";\nimport { Order } from \"../../db/models/order\";\nimport * as sq from 'sequelize';\nimport { OrderItemStatus } from \"../../models/order\";\nimport Butcher from \"../../db/models/butcher\";\n\n\nexport default class ButcherStats extends BaseTask {\n\n    get interval() {\n        return \"0 0 */8 * * *\"\n    }\n\n\n\n    async run() {\n        console.log('running product stats job', Date.now())\n        await Order.sequelize.query(`\n        \n        update Products as dest, \n        (\n        SELECT oi.productid as pid, avg(r.userRating1) as ratingAvg, count(*) as total FROM Reviews r, Orders o, OrderItems oi \n                WHERE r.type='order' and oi.status='teslim edildi' and r.ref1=o.id and oi.orderid = o.id \n                group by oi.productid\n        ) as src\n        set \n        dest.ratingValue = src.ratingAvg,\n        dest.reviewCount = src.total\n        where\n        dest.id = src.pid\n\n        `,\n            {\n                type: sq.QueryTypes.BULKUPDATE,\n            });\n        console.log('done product stats job', Date.now())\n    }\n}"],"sourceRoot":"../../../src/"}